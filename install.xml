<?xml version="1.0" encoding="UTF-8" ?>
<modification>
  <generator>Created with OpenIX - https://openix.io/en/tool/opencart/ocmod</generator>
  <name>Pace for Opencart</name>
  <version>1.0.5-rc03</version>
  <code>1.0.5-rc03</code>
  <author>Pace Enterprise Pte Ltd</author>
  <link>https://developers.pacenow.co/</link>

  <!-- single widget load html -->
  <file path="catalog/view/theme/*/template/product/product.twig" error="log">
    <operation>
      <search><![CDATA[<div id="product">]]></search>
      <add position="replace"><![CDATA[
     <div id="single-widget" 
     data-enable='{{payment_pace_checkout_product_widget_status}}'
     data-price='{{pace_price}}' 
     data-theme='{{payment_pace_checkout_product_theme_color}}'
     data-primary='{{payment_pace_checkout_product_primary_color}}'
     data-second='{{payment_pace_checkout_product_second_color}}'
     data-fontsize='{{payment_pace_checkout_product_fontsize}}'
     style='{{payment_pace_checkout_product_widget_style}}'
     > </div>
      <div id="product">
     ]]></add>
    </operation>
  </file>

  <!-- multiple widget load html -->
  <file path="catalog/view/theme/*/template/product/category.twig" error="log">
    <operation>
      <search><![CDATA[{% if product.rating %}]]></search>
      <add position="replace"><![CDATA[
      <div id="multiple-widget" 
      data-price='{{product.pace_price}}'
      data-enable='{{payment_pace_checkout_catalog_widget_status}}'
      data-theme='{{payment_pace_checkout_catalog_theme_color}}'
      data-primary='{{payment_pace_checkout_catalog_primary_color}}'
      data-fontsize='{{payment_pace_checkout_catalog_fontsize}}'
      style='{{payment_pace_checkout_catalog_widget_style}}'
      > </div>
      {% if product.rating %}
      ]]></add>
    </operation>
  </file>

  <!-- processing order when paying susscessfully -->
  <file path="catalog/controller/checkout/success.php" error="log">
    <operation>
      <search><![CDATA[if (isset($this->session->data['order_id'])) {]]></search>
      <add position="after">
        <![CDATA[
          $order_id = $this->session->data['order_id'];
          $transactionId = $_GET['transactionId'];
          $merchantReferenceId = $_GET['merchantReferenceId'];

          if ( $order_id == $merchantReferenceId ) {
            $this->load->model('setting/setting');
            $pace_settings = $this->model_setting_setting->getSetting('payment_pace_checkout');
            $approved_status = (int) $pace_settings['payment_pace_checkout_order_status_transaction_approved'];

            // update order status
            $this->load->model('checkout/order');

	        	$this->model_checkout_order->addOrderHistory($order_id, $approved_status);
            $sql = sprintf( "UPDATE `%sorder` SET order_status_id=%d WHERE order_id=%d", DB_PREFIX, $approved_status, $order_id );
            $this->db->query( $sql );
          }
          $this->load->language('checkout/success');
        ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/extension/module/featured.twig" error="log">
    <operation>
      <search regex="true"><![CDATA[~(.*?(<p\sclass="price">\D+?<\/p>))~]]></search>
      <add position="after"><![CDATA[
      <p class="price"> {% if not product.special %} {{ product.price }} {% else %} <span class="price-new">{{ product.special }}</span> <span class="price-old">{{ product.price }}</span> {% endif %} {% if product.tax %} <span class="price-tax">{{ text_tax }} {{ product.tax }}</span> {% endif %} </p>
      <div id="multiple-widget"data-price='{{product.pace_price}}'data-enable='{{payment_pace_checkout_catalog_widget_status}}'data-theme='{{payment_pace_checkout_catalog_theme_color}}'data-primary='{{payment_pace_checkout_catalog_primary_color}}'data-fontsize='{{payment_pace_checkout_catalog_fontsize}}'style='{{payment_pace_checkout_catalog_widget_style}}'> </div>
     ]]></add>
    </operation>
  </file>


<!-- load js file -->
<file path="catalog/controller/common/header.php" error="log">
    <operation>
      <search><![CDATA[$data['analytics'] = array();]]></search>
      <add position="replace"><![CDATA[
        $this->load->model('setting/setting');
        $this->load->model('extension/module/pace');
        $setting = $this->model_setting_setting->getSetting('payment_pace_checkout');
        $isPlanAvailabel = $this->model_extension_module_pace->isAvailable();

        if ( $isPlanAvailabel ) {
          $getPacePlan = $isPlanAvailabel;
          
          // append Pace SDK
          printf('<script> var pacePlan = %s; </script> ', json_encode( $getPacePlan ) );

          if ( isset($setting['payment_pace_checkout_fallback_widget']) ) {
            $this->document->addScript('/catalog/view/javascript/pace/checkout.js');  
          } else {
            $this->document->addScript('/catalog/view/javascript/pace/checkout-without-fallback.js'); 
          }

          $this->document->addScript('/catalog/view/javascript/pace/pace-widget.js');
          $this->document->addStyle('/catalog/view/javascript/pace/css/pace.css');
          if ( $setting['payment_pace_checkout_status'] && !$setting['payment_pace_checkout_status_sandbox'] ) {
              $this->document->addScript('https://pay.pacenow.co/pace-pay.js', 'header', true);
          } else if($setting['payment_pace_checkout_status_sandbox']){
              $this->document->addScript('https://pay-playground.pacenow.co/pace-pay.js', 'header', true);
          }
        }
          
    $data['analytics'] = array();
     ]]></add>
    </operation>
  </file>

  

<!-- single widget logic change money -->
  <file path="catalog/controller/product/product.php" error="log">
    <operation>
      <search><![CDATA[$data['price'] = $this->currency->format($this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[

      $data['pace_price'] = $this->currency->format(
        $this->tax->calculate(
          $product_info['price'], 
          $product_info['tax_class_id'], 
          $this->config->get('config_tax')
        ),
        $this->session->data['currency'],
        '',
        false
      ); 

		  $this->load->model('setting/setting');
      $setting = $this->model_setting_setting->getSetting('payment_pace_checkout');
		  $data['payment_pace_checkout_product_widget_status'] = $setting['payment_pace_checkout_product_widget_status'];
      $data['payment_pace_checkout_product_theme_color'] = $setting['payment_pace_checkout_product_theme_color'];
		  $data['payment_pace_checkout_product_primary_color'] = $setting['payment_pace_checkout_product_primary_color'];
		  $data['payment_pace_checkout_product_second_color'] = $setting['payment_pace_checkout_product_second_color'];
		  $data['payment_pace_checkout_product_fontsize'] = $setting['payment_pace_checkout_product_fontsize'];
		  $data['payment_pace_checkout_product_widget_style'] = $setting['payment_pace_checkout_product_widget_style'];
      $data['price'] = $this->currency->format($this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
     ]]></add>
    </operation>
  </file>


   <file path="catalog/controller/product/product.php" error="log">
    <operation>
      <search><![CDATA[$data['special'] = $this->currency->format($this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
      $data['special'] = $this->currency->format($this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
      $data['pace_price'] = $this->currency->format(
        $this->tax->calculate(
          $product_info['special'], 
          $product_info['tax_class_id'], 
          $this->config->get('config_tax')
        ), 
        $this->session->data['currency'],
        '',
        false
      );
     ]]></add>
    </operation>
  </file>


<!-- multiple widget logic change money -->



   <file path="catalog/controller/product/category.php" error="log">
    <operation>
      <search><![CDATA[$price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
      $price = $this->currency->format($this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
      $this->load->model('setting/setting');
      $setting = $this->model_setting_setting->getSetting('payment_pace_checkout');
      $data['payment_pace_checkout_catalog_widget_status'] = $setting['payment_pace_checkout_catalog_widget_status'];
      $data['payment_pace_checkout_catalog_theme_color'] = $setting['payment_pace_checkout_catalog_theme_color'];
		  $data['payment_pace_checkout_catalog_primary_color'] = $setting['payment_pace_checkout_catalog_primary_color'];
		  $data['payment_pace_checkout_catalog_fontsize'] = $setting['payment_pace_checkout_catalog_fontsize'];
		  $data['payment_pace_checkout_catalog_widget_style'] = $setting['payment_pace_checkout_catalog_widget_style'];

      $pace_price = $this->currency->format(
        $this->tax->calculate(
          $result['price'], 
          $result['tax_class_id'], 
          $this->config->get('config_tax')
        ), 
        $this->session->data['currency'],
        '',
        false
      );
     ]]></add>
    </operation>
  </file>


  <file path="catalog/controller/product/category.php" error="log">
    <operation>
      <search><![CDATA[	$special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
      $special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);

      $pace_price = $this->currency->format(
        $this->tax->calculate(
          $result['special'], 
          $result['tax_class_id'], 
          $this->config->get('config_tax')
        ),
        $this->session->data['currency'],
        '',
        false
      );
     ]]></add>
    </operation>
  </file>

  <file path="catalog/controller/product/category.php" error="log">
    <operation>
      <search><![CDATA[	$special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
      $special = $this->currency->format($this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
      $pace_price = $this->currency->format(
        $this->tax->calculate(
          $result['special'], 
          $result['tax_class_id'], 
          $this->config->get('config_tax')
        ),
        $this->session->data['currency'],
        '',
        false
      );
     ]]></add>
    </operation>
  </file>



  <file path="catalog/controller/product/category.php" error="log">
    <operation>
      <search><![CDATA['price'       => $price,]]></search>
      <add position="replace"><![CDATA[
     'price'      => $price,
     'pace_price' => $pace_price,
     ]]></add>
    </operation>
  </file>


<!-- multiple widget for feature page -->


<file path="catalog/controller/extension/module/featured.php" error="log">
    <operation>
      <search><![CDATA[$price = $this->currency->format($this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
    $price = $this->currency->format($this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
    $pace_price = $this->currency->format(
      $this->tax->calculate(
        $product_info['price'], 
        $product_info['tax_class_id'], 
        $this->config->get('config_tax')
      ), 
      $this->session->data['currency'],
      '',
      false
    );
     $this->load->model('setting/setting');
      $setting_pace = $this->model_setting_setting->getSetting('payment_pace_checkout');
      $data['payment_pace_checkout_catalog_widget_status'] = $setting_pace['payment_pace_checkout_catalog_widget_status'];
      $data['payment_pace_checkout_catalog_theme_color'] = $setting_pace['payment_pace_checkout_catalog_theme_color'];
		  $data['payment_pace_checkout_catalog_primary_color'] = $setting_pace['payment_pace_checkout_catalog_primary_color'];
		  $data['payment_pace_checkout_catalog_fontsize'] = $setting_pace['payment_pace_checkout_catalog_fontsize'];
		  $data['payment_pace_checkout_catalog_widget_style'] = $setting_pace['payment_pace_checkout_catalog_widget_style'];
     ]]></add>
    </operation>
  </file>


  <file path="catalog/controller/extension/module/featured.php" error="log">
    <operation>
      <search><![CDATA[$special = $this->currency->format($this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);]]></search>
      <add position="replace"><![CDATA[
    $special = $this->currency->format($this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax')), $this->session->data['currency']);
    $pace_price = $this->currency->format(
      $this->tax->calculate(
        $product_info['special'], 
        $product_info['tax_class_id'], 
        $this->config->get('config_tax')
      ), 
      $this->session->data['currency'],
      '',
      false
    );
     ]]></add>
    </operation>
  </file>


   <file path="catalog/controller/extension/module/featured.php" error="log">
    <operation>
      <search><![CDATA['price'       => $price,]]></search>
      <add position="replace"><![CDATA[
     'price'      => $price,
     'pace_price' => $pace_price,
     ]]></add>
    </operation>
  </file>


 <file path="catalog/model/checkout/order.php" error="log">
    <operation>
      <search><![CDATA[// Update the DB with the new statuses]]></search>
      <add position="replace"><![CDATA[
     
     if($order_status_id === "7") {
				$this->load->model('extension/module/pace');
				$this->model_extension_module_pace->cancel_transaction($order_info);
			}

      // Update the DB with the new statuses
     ]]></add>
    </operation>
  </file>


  <file path="catalog/controller/checkout/failure.php" error="log">
    <operation>
      <search><![CDATA[public function index() {]]></search>
      <add position="replace"><![CDATA[
     
    private function handleCancelTransaction()
    {

        $this->load->model('extension/module/pace');
        $order_id = isset($this->session->data['order_id']) ? $this->session->data['order_id'] : null;

        if (!$order_id) {
            $url = $this->url->link('common/home', '', true);
            header("Location: $url");
            die();
        }
        $user = $this->model_extension_module_pace->getUser();
        $transaction = $this->model_extension_module_pace->getOrderTransaction($order_id) ? json_decode($this->model_extension_module_pace->getOrderTransaction($order_id)['data'], true) : [];
        if (!$transaction) {
          return;
        }
        $ch = curl_init();

        curl_setopt($ch, CURLOPT_URL, $user['api'] . '/v1/checkouts/' . $transaction['transactionID'] . '/cancel');
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_POST, 1);

        $headers = array();
        $headers[] = 'Content-Type: text/plain';

        $headers[] = 'Authorization: Basic ' . base64_encode($user['user_name'] . ':' . $user['password']);;
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

        $result = curl_exec($ch);

        if (curl_errno($ch)) {
            echo 'Error:' . curl_error($ch);
        }
        $result = json_decode($result);
        if (!!$result->success) {
          $this->load->model('setting/setting');
          $setting = $this->model_setting_setting->getSetting('payment_pace_checkout');

          $this->model_extension_module_pace->addOrderHistory($order_id, (int) $setting['payment_pace_checkout_order_status_transaction_cancelled']);
        }
        curl_close($ch);
    }

    public function index() {
       $result = $this->handleCancelTransaction();
        if (isset($this->session->data['order_id'])) {
            $this->cart->clear();

            unset($this->session->data['shipping_method']);
            unset($this->session->data['shipping_methods']);
            unset($this->session->data['payment_method']);
            unset($this->session->data['payment_methods']);
            unset($this->session->data['guest']);
            unset($this->session->data['comment']);
            unset($this->session->data['order_id']);
            unset($this->session->data['coupon']);
            unset($this->session->data['reward']);
            unset($this->session->data['voucher']);
            unset($this->session->data['vouchers']);
            unset($this->session->data['totals']);
        }
     ]]></add>
    </operation>
  </file>



<!-- fix not show widget -->
 <file path="system/{engine,library}/{action,loader,config,language}*.php|system/library/template/template.php">
    <operation>
      <search regex="true">
        <![CDATA[~(require|include)(_once)?\(([^)]+)~]]>
      </search>
      <add position="replace">
        <![CDATA[$1$2(modification($3)]]>
      </add>
    </operation>
  </file>
  <file path="system/library/template/twig.php">
    <operation>
      <search>
        <![CDATA[if (is_file($file)) {]]>
      </search>
      <add position="replace">
        <![CDATA[if (defined('DIR_CATALOG') && is_file(DIR_MODIFICATION . 'admin/view/template/' . $filename . '.twig')) {	
                $code = file_get_contents(DIR_MODIFICATION . 'admin/view/template/' . $filename . '.twig');
            } elseif (is_file(DIR_MODIFICATION . 'catalog/view/theme/' . $filename . '.twig')) {
                $code = file_get_contents(DIR_MODIFICATION . 'catalog/view/theme/' . $filename . '.twig');
            } elseif (is_file($file)) {]]>
      </add>
    </operation>
  </file>


   <file path="admin/controller/startup/login.php">
      <operation>
         <search index="0,1"><![CDATA[$ignore = array(]]></search>
         <add position="after"><![CDATA[			'extension/payment/pace_checkout/runCron',]]></add>
      </operation>
   </file>

   <file path="admin/controller/startup/permission.php">
      <operation>
         <search index="0"><![CDATA[$ignore = array(]]></search>
         <add position="after"><![CDATA[				'extension/payment/pace_checkout',]]></add>
      </operation>
   </file> 

    <file path="catalog/controller/product/search.php" error="log">
    <operation>
      <search><![CDATA['price'       => $price,]]></search>
      <add position="replace"><![CDATA[
     'price'      => $price,
     'pace_price' => $special ? $special : $price,
     ]]></add>
    </operation>
  </file>


   <file path="catalog/controller/product/search.php" error="log">
    <operation>
      <search><![CDATA[$data['products'] = array();]]></search>
      <add position="replace"><![CDATA[
      $data['products'] = array();
      $this->load->model('setting/setting');
      $setting_pace = $this->model_setting_setting->getSetting('payment_pace_checkout');
      $data['payment_pace_checkout_catalog_widget_status'] = $setting_pace['payment_pace_checkout_catalog_widget_status'];
      $data['payment_pace_checkout_catalog_theme_color'] = $setting_pace['payment_pace_checkout_catalog_theme_color'];
		  $data['payment_pace_checkout_catalog_primary_color'] = $setting_pace['payment_pace_checkout_catalog_primary_color'];
		  $data['payment_pace_checkout_catalog_fontsize'] = $setting_pace['payment_pace_checkout_catalog_fontsize'];
		  $data['payment_pace_checkout_catalog_widget_style'] = $setting_pace['payment_pace_checkout_catalog_widget_style'];
     ]]></add>
    </operation>
  </file>

  <file path="catalog/view/theme/*/template/product/search.twig" error="log">
    <operation>
      <search><![CDATA[{% if product.rating %}]]></search>
      <add position="replace"><![CDATA[
      <div id="multiple-widget" 
      data-price='{{product.pace_price}}'
      data-enable='{{payment_pace_checkout_catalog_widget_status}}'
      data-theme='{{payment_pace_checkout_catalog_theme_color}}'
      data-primary='{{payment_pace_checkout_catalog_primary_color}}'
      data-fontsize='{{payment_pace_checkout_catalog_fontsize}}'
      style='{{payment_pace_checkout_catalog_widget_style}}'
      > </div>
     {% if product.rating %}
     ]]></add>
    </operation>
  </file>

  <!-- Admin Orders area -->
  <file path="admin/language/en-gb/sale/order.php">
    <operation>
      <search><![CDATA[$_['text_picklist']              = 'Dispatch Note';]]></search>
      <add position="after"><![CDATA[$_['text_transaction']      = 'Pace Transaction';]]></add>
    </operation>
  </file>

  <file path="admin/model/sale/order.php">
    <operation>
      <search><![CDATA[$this->load->model('customer/customer');]]></search>
      <add position="after"><![CDATA[
        $transaction_query = $this->db->query("SELECT transaction_id FROM `". DB_PREFIX ."order_transaction` WHERE order_id = '" . (int) $order_id . "'");
        if ( $transaction_query->num_rows ) {
          $transaction = $transaction_query->row['transaction_id'];
        } else {
          $transaction = '';
        }
      ]]></add>
    </operation>
  </file>

  <file path="admin/model/sale/order.php">
    <operation>
      <search><![CDATA['date_added'              => $order_query->row['date_added'],]]></search>
      <add position="after"><![CDATA[
        'pace_transaction' => $transaction,
      ]]></add>
    </operation>
  </file>

  <file path="admin/controller/sale/order.php">
    <operation>
      <search><![CDATA[$this->response->setOutput($this->load->view('sale/order_info', $data));]]></search>
      <add position="before"><![CDATA[
        $data['payment_code'] = $order_info['payment_code'];
        $data['pace_transaction'] = $order_info['pace_transaction'];
      ]]></add>
    </operation>
  </file>

  <file path="admin/view/template/sale/order_info.twig">
    <operation>
      <search regex="true"><![CDATA[~(<tr>\s+<td>{+\s?text_affiliate\D+\{\%\s?endif\D+<\/tr>)~]]></search>
      <add trim="true" offset="1"><![CDATA[
        <tr> <td>{{ text_affiliate }} {% if affiliate %} (<a href="{{ affiliate }}">{{ affiliate_firstname }} {{ affiliate_lastname }}</a>) {% endif %}</td> <td class="text-right">{{ commission }}</td> <td class="text-center">{% if affiliate %} {% if not commission_total %} <button id="button-commission-add" data-loading-text="{{ text_loading }}" data-toggle="tooltip" title="{{ button_commission_add }}" class="btn btn-success btn-xs"><i class="fa fa-plus-circle"></i></button> {% else %} <button id="button-commission-remove" data-loading-text="{{ text_loading }}" data-toggle="tooltip" title="{{ button_commission_remove }}" class="btn btn-danger btn-xs"><i class="fa fa-minus-circle"></i></button> {% endif %} {% else %} <button disabled="disabled" class="btn btn-success btn-xs"><i class="fa fa-plus-circle"></i></button> {% endif %}</td> </tr>

        {% if payment_code == 'pace_checkout' and pace_transaction %}<tr> <td>{{ text_transaction }}</td> <td class="text-right">{{ pace_transaction }}</td> <td class="text-center"><button disabled="disabled" class="btn btn-success btn-xs"><i class="fa fa-eye"></i></button></td> </tr> {% endif %}
      ]]></add>
    </operation>
  </file>

  <!-- Manually update order status: Pace transaction status validated -->
  <file path="catalog/language/en-gb/api/order.php">
    <operation>
      <search><![CDATA[$_['error_not_found']        = 'Warning: Order could not be found!';]]></search>
      <add position="after"><![CDATA[
        $_['unable_pace_transaction'] = 'Warning: Unable to validate Pace transactions!';
        $_['unable_pace_update_order'] = 'Warning: Cannot update order status!';
      ]]></add>
    </operation>
  </file>

  <file path="catalog/controller/api/order.php">
    <operation>
      <search regex="true"><![CDATA[~(if\s?\(\$order_info\)\s\{\D+\$this->model_checkout_order->addOrderHistory\(\D+\} )~]]></search>
      <add trim="true"><![CDATA[
        if ($order_info) {
          if ( 'pace_checkout' === $order_info['payment_code'] ) {

            /* get Pace transaction is attached to the order */
            $transaction = $this->db->query("SELECT transaction_id FROM `". DB_PREFIX ."order_transaction` WHERE order_id = '" . (int) $order_id . "'");
                    
            if ( !$transaction->num_rows ) {
              $json['error'] = $this->language->get('unable_pace_transaction');
            } else {
              $transaction_id = $transaction->row['transaction_id'];

              /* check Pace transaction before update Order status */
              $this->load->model('extension/module/pace');

              /* get Pace credential */
              $credential = $this->model_extension_module_pace->getUser();
                      
              $ch = curl_init();
              curl_setopt($ch, CURLOPT_URL, $credential['api'] . '/v1/checkouts/' . $transaction_id);
              curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
              curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');
              curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                'content-Type: text/plain',
                'cache-control: no-cache',
                'authorization: Basic ' . base64_encode($credential['user_name'] . ':' . $credential['password'])
              ));
              $result = json_decode( curl_exec($ch) );
              $errors = curl_error($ch);
              curl_close($ch);

              if ( $errors ) {
                $json['error'] = $this->language->get('unable_pace_transaction');
              } else {
                $status_convert = $this->model_extension_module_pace->updateOrderStatus( $result->status );

                if ( (int) $status_convert != $this->request->post['order_status_id'] ) {
                  $json['error'] = sprintf( $this->language->get( 'unable_pace_update_order' ),  );
                } else {
                  $this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override']);
                  $json['success'] = $this->language->get('text_success');
                }
              }
            }
          } else {
            $this->model_checkout_order->addOrderHistory($order_id, $this->request->post['order_status_id'], $this->request->post['comment'], $this->request->post['notify'], $this->request->post['override']);
            $json['success'] = $this->language->get('text_success');  
          }
        } 
      ]]></add>
    </operation>
  </file>

   <file path="catalog/model/checkout/order.php">
    <operation>
      <search><![CDATA[$this->db->query("INSERT INTO " . DB_PREFIX . "order_history SET order_id = '" . (int)$order_id . "', order_status_id = '" . (int)$order_status_id . "', notify = '" . (int)$notify . "', comment = '" . $this->db->escape($comment) . "', date_added = NOW()");]]></search>
      <add position="after"><![CDATA[
        $this->load->model('extension/module/pace');
			$this->model_extension_module_pace->track_order_status_change_by($order_id, $order_status_id , 'user');
      ]]></add>
    </operation>
  </file>

</modification>

